name: Update Backend .env and Restart

on:
  repository_dispatch:
    types: [update-backend-env]

jobs:
  update-env:
    runs-on: ubuntu-latest
    environment: Development

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-central-1

    - name: Get MongoDB Private IP
      run: |
        MONGODB_IP=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=terraform-mongodb" \
                    "Name=instance-state-name,Values=running" \
          --query "Reservations[0].Instances[0].PrivateIpAddress" \
          --output text)
        echo "MONGODB_IP=$MONGODB_IP" >> $GITHUB_ENV

    - name: Update .env on Backend EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i private_key.pem ec2-user@<BACKEND_PUBLIC_IP> <<EOF
        echo "MONGO_URI=mongodb://${{ secrets.S3_MONGO_USER }}:${{ secrets.S3_MONGO_PASSWORD }}@$MONGODB_IP:27017/admin?authSource=admin" > /home/ec2-user/app/.env
        sudo systemctl restart scheduler
        EOF
