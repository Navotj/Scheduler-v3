  <script src="/scripts/login.js"></script>
  <script src="/scripts/register.js"></script>
  <script>
    let isAuthenticated = false;
    let currentUsername = null;

    async function checkAuth() {
      console.log("[DEBUG] checkAuth() called");
      const controller = new AbortController();
      setTimeout(() => controller.abort(), 3000);
      try {
        const res = await fetch('/check', {
          credentials: 'include',
          cache: 'no-cache',
          signal: controller.signal
        });
        console.log("[DEBUG] /check response status:", res.status);
        if (res.status === 200) {
          const data = await res.json();
          console.log("[DEBUG] /check response data:", data);
          isAuthenticated = true;
          currentUsername = data.username || 'user';
        } else {
          console.warn("[DEBUG] /check failed, status not 200");
          isAuthenticated = false;
          currentUsername = null;
        }
      } catch (err) {
        console.error("[DEBUG] /check error:", err);
        isAuthenticated = false;
        currentUsername = null;
      }
      updateAuthUI();
    }

    function updateAuthUI() {
      console.log("[DEBUG] updateAuthUI() - isAuthenticated:", isAuthenticated, "username:", currentUsername);
      const userLabel = document.getElementById('user-label');
      const authButton = document.getElementById('auth-button');

      if (isAuthenticated) {
        userLabel.textContent = `Signed in as ${currentUsername}`;
        userLabel.style.display = 'inline';
        authButton.textContent = 'Logout';
        authButton.onclick = logout;
      } else {
        userLabel.style.display = 'none';
        authButton.textContent = 'Login';
        authButton.onclick = () => openModal('/pages/login.html');
      }
    }

    async function logout() {
      console.log("[DEBUG] logout() called");
      try {
        const res = await fetch('/logout', {
          method: 'POST',
          credentials: 'include'
        });
        console.log("[DEBUG] /logout response status:", res.status);
      } catch (err) {
        console.error("[DEBUG] logout error:", err);
      }
      isAuthenticated = false;
      currentUsername = null;
      updateAuthUI();
    }

    function runModalInit(path) {
      console.log("[DEBUG] runModalInit() with path:", path);
      if (path.includes('register.html') && window.initRegisterForm) {
        console.log("[DEBUG] Initializing register form");
        window.initRegisterForm();
      } else if (path.includes('login.html') && window.initLoginForm) {
        console.log("[DEBUG] Initializing login form");
        window.initLoginForm();
      }
    }

    function openModal(path) {
      console.log("[DEBUG] openModal() called with:", path);
      const overlay = document.getElementById('modal-overlay');
      const container = document.getElementById('modal-container');
      fetch(path)
        .then(res => res.text())
        .then(html => {
          console.log("[DEBUG] Loaded modal HTML from", path);
          container.innerHTML = html;
          overlay.style.display = 'flex';
          document.body.classList.add('modal-active');
          runModalInit(path);
        })
        .catch(err => console.error("[DEBUG] openModal error:", err));
    }

    function swapModal(path) {
      console.log("[DEBUG] swapModal() called with:", path);
      const container = document.getElementById('modal-container');
      fetch(path)
        .then(res => res.text())
        .then(html => {
          console.log("[DEBUG] Swapped modal content from", path);
          container.innerHTML = html;
          document.body.classList.add('modal-active');
          runModalInit(path);
        })
        .catch(err => console.error("[DEBUG] swapModal error:", err));
    }

    function closeModal() {
      console.log("[DEBUG] closeModal() called");
      const overlay = document.getElementById('modal-overlay');
      const container = document.getElementById('modal-container');
      overlay.style.display = 'none';
      document.body.classList.remove('modal-active');
      container.innerHTML = '';
    }

    // expose for login/register modals
    window.openModal = openModal;
    window.swapModal = swapModal;
    window.closeModal = closeModal;

    // let login.js update this page after successful sign-in
    window.setAuthState = function(authenticated, username) {
      console.log("[DEBUG] setAuthState() called with:", authenticated, username);
      isAuthenticated = !!authenticated;
      currentUsername = authenticated ? username : null;
      updateAuthUI();
    };

    document.getElementById('open-auth').addEventListener('click', () => {
      console.log("[DEBUG] open-auth button clicked");
      if (isAuthenticated) return;
      openModal('/pages/login.html');
    });

    document.getElementById('year').textContent = new Date().getFullYear();
    document.addEventListener('DOMContentLoaded', () => {
      console.log("[DEBUG] DOMContentLoaded fired, calling checkAuth()");
      checkAuth();
    });
  </script>
